---
title: "Group Project 2, Case Study 4"
Author: "Karyn Brehmeyer, Charles Hanks, and Isaac Johnson"
output: html_document
date: "2023-03-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/Users/charleshanks/repos/chickadees')
```

Loading Packages: 
```{r cars}
library(tidyverse)
library(skimr)
library(survival)
library(survminer)
library(fitdistrplus)
```

Reading in datasets: 
```{r}
lever = read_csv('LeverPullingPerformance.csv')
paper = read_csv('PaperRippingPerformance.csv')
pr = read_csv('Persistence&Repeatability.csv')
```

#GROUP PROJECT 2: CHICKADEES
##Study:Characterizing innovators: ecological and individual predictors of problem-solving performance
Prasher, Sanjay; Evans, Julian C.; Thompson, Megan J.; Morand-Ferron, Julie (2019)

##Data source: 
<https://datadryad.org/stash/dataset/doi:10.5061/dryad.s83d4n1>

##Abstract: 
Behavioural innovation, the use of new behaviours or existing ones in novel contexts, can have important ecological and evolutionary consequences for animals. An understanding of these consequences would be incomplete without considering the traits that predispose certain individuals to exhibit innovative behaviour. Several individual and ecological variables are hypothesized to affect innovativeness, but empirical studies show mixed results. We examined the effects of dominance rank, exploratory personality, and urbanisation on the innovativeness of wild-caught black-capped chickadees using a survival analysis of their performance in two problem-solving tasks. Additionally, we provide one of the first investigations of the predictors of persistence in a problem-solving context. For lever pulling, we found a trend for dominants to outperform subordinates, particularly in rural birds, which did not align with predictions from the necessity drives innovation hypothesis. When examining possible explanations for this trend we found that older chickadees outperformed younger birds. This follow-up analysis also revealed a positive effect of exploratory personality on the lever-pulling performance of chickadees. Our results suggest that experience may foster innovation in certain circumstances, for instance via the application of previously-acquired information or skills to a novel problem. As we found different predictors for both tasks, this suggests that task characteristics influence the innovative propensity of individuals, and that their effects should be investigated experimentally.

##Primary Questions of Interest: 
What was the overall time to solving the problems (lever pulling, paper ripping, and persistence & repeatability) for chickadees?  What covariates/characteristics were most closely predictive of whether a chickadee figured out the problems?


##DATASET 1: Lever 

Variables: 

indiv: individual band number identification
latency: latency to solve or become censored in the lever-pulling trials
status: censoring status of latency to solve the lever-pulling task used for cox regression (0 = censored, 1 = uncensored)
tstart: start time (in seconds) of each time interval used for the extended cox regression
tstop: stop time (in seconds) of each time interval used for the extended cox regression
contacts: number of contacts made with the task in each time interval
domscore: dominance score based on interactions between birds at RFID feeders.
urbanscore: urbanization score generated by PCA analysis used to infer degree of urbanization at each site.
explscore: exploration score generated by PCA analysis.
solve: indicator of whether the task was solved in each time interval (0 = unsolved, 1 = solved)
site: code of each field site.
habitat: rural (urban score < 0) or urban (urban score > 0) habitat type.
age: age class â€“ adult or juvenile.
sex: female or male.

Preliminary EDA of lever dataset: 
```{r}
skim(lever)
summary(lever)

head(lever)
#it looks like each row is a 60 second interval, so for each of 65 birds that are in this dataset there are one or multiple rows, depending on how long it took them to solve the lever problem.

lever %>% 
  group_by(indiv) %>% 
    count()

lever %>% 
  filter(solve == 1) %>% 
    group_by(indiv) %>% 
      summarize(time = max(tstop), status)
#38 of the 65 birds in dataset solved the problem 

lever %>% 
  filter(status == 0) %>%  
    group_by(indiv) %>% 
      summarize(time = max(tstop)) 
#27 of 65 birds in dataset did not solve the lever problem 

lever %>% 
  group_by(indiv) %>% 
    summarize(min_time = min(tstart))
#all the birds start at 0 

```


```{r}
#this summary table will be used to for our survival analysis so there is 1 row per bird with the time-to-event (pulling the lever) as variable "time"
lever2 = lever %>% 
    group_by(status, indiv, habitat,age) %>% 
      summarize (time = max(tstop), 
                 contacts = sum(contacts), 
                 domscore = unique(domscore), 
                 urbanscore = unique(urbanscore), 
                 explscore = unique(explscore), 
                 solve = max(solve))
     
#1st km curve for all birds in trial (no grouping)                                       
lever2.km = survfit(Surv(lever2$time,lever2$status) ~ 1)

#km table 
summary(lever2.km)
print(lever2.km)
#median time to pull lever: 1320 seconds, or 22 minutes. 


ggsurvplot(fit = lever2.km, data = lever2, risk.table = F, conf.int = T, surv.median.line = "hv") + 
  labs(title = "Survival Analysis of Chickadees Solving Lever Problem",
       y = "probability of not pulling lever", 
       x = "Time (seconds)")

#transforming y to be 1 -S(t) for better interpretability given type of event (solving a problem)
ggsurvplot(fit = lever2.km, data = lever2, risk.table = F, fun = "event", conf.int = T, surv.median.line = "hv") +
    labs(title = "Survival Analysis of Chickadees Solving Lever Problem",
       y = "Probability of Pulling Lever", 
       x = "Time (seconds)")


```

Binning bird characteristic variables for survival analysis
```{r}
#binning domscore: 
lever2 = lever2 %>%  mutate(dom_bin = case_when(
                                          domscore <= .50 ~ "low", 
                                          domscore > .50 ~ "high"))

#distribution of explscore: 
ggplot(data = lever2, aes(x = explscore)) + geom_histogram(binwidth = 3)
#there is quite the outlier! That's one intrepid bird.

#binning explscore: 
lever2 = lever2 %>% mutate(expl_bin = case_when(
                                explscore <= -.89 ~ "low", 
                                explscore > -.89 ~ "high"))
```

Age matters
```{r}
#creating new km table, grouping by type of habitat and age of bird: 
lever2.km2 = survfit(Surv(lever2$time,lever2$status) ~ lever2$age) 

ggsurvplot(fit = lever2.km2, data = lever2, risk.table = F, conf.int = F, fun = "event", linetype = "strata", legend = "right") + 
  labs(title = "Adults are better at Lever Pulling Task",
       y = "Probability of Pulling Lever", 
       x = "Time (seconds)")

#log rank test
survdiff(Surv(lever2$time,lever2$status) ~ lever2$age)
# p = .04 

```


Dominance Score affects bird's task performance 
```{r}
#km table, grouping by how dominant and exploratory the birds are: 
lever2.km3 = survfit(Surv(lever2$time,lever2$status) ~ strata(lever2$dom_bin))

ggsurvplot(fit = lever2.km3, data = lever2, risk.table = F, conf.int = F, fun = "event", linetype = "strata", legend = "right") + 
  labs(title = "The More Dominant are Better at Pulling Lever",
       y = "Probability of Pulling Lever", 
       x = "Time (seconds)")

#log rank test 
survdiff(Surv(lever2$time,lever2$status) ~ lever2$dom_bin) #p = .09
survdiff(Surv(lever2$time,lever2$status) ~ lever2$domscore) #p = .05

#This large p values are probably due to the very small sample size!
```

##Initial Findings:

From the survival curves above, the data suggests adult, rural birds with a high dominance and exploration scores are the most likely to complete the lever pulling task. It appears that age and dominance play a large role in determining likelihood in solving the problem. 

Let's run a parametric regression model to compare coefficents for these covariates.  

First things first, fitting our data to a parametric distribution: 


```{r}
#preparing lever2 dataset for fitdistcens: 

lever3 = lever2 %>% mutate(left= ifelse(time == 0,time+.001,time), 
                  right= ifelse(status == 1,left, NA))

#weibull
weibullFit.lever3=fitdistcens(data.frame(lever3[,c("left","right")]), dist = "weibull")
summary(weibullFit.lever3)$estimate
plot(weibullFit.lever3)

#fix.arg shape = 1 

#exponential 
expFit.lever3 = fitdistcens(data.frame(lever3[,c("left","right")]), dist = "exp") #exponential does not work 
summary(expFit.lever3)
plot(expFit.lever3)

#lognnormal 
logFit.lever3 = fitdistcens(data.frame(lever3[,c("left","right")]), dist = "lnorm")
summary(logFit.lever3)$estimate
plot(logFit.lever3)



#assessing goodness of fits
weibullFit.lever3$aic
logFit.lever3$aic

#model vlues
lnorm_values = rlnorm(100, meanlog = 7.536, sdlog =  2.6)



#gammaFit.lever3 = fitdistcens(data.frame(lever3[,c("left","right")]), dist = "gamma")
#gamma doesn't work either! 
   
#our lognormal distribution is the best fit 

cdfcompcens(list(logFit.lever3,weibullFit.lever3),
            legendtext=c("Lognormal","Weibull"),
            xlab="Time to Pull Lever (seconds)",
            plotstyle = "ggplot")


qqcompcens(list(logFit.lever3,weibullFit.lever3), 
           legendtext=c("Lognormal","Weibull")
           ,plotstyle = "ggplot")


meanlog = summary(logFit.lever3)$estimate[1]
sdlog = summary(logFit.lever3)$estimate[2]

#What percent of birds are expected to pull the lever within 30 minutes? 
plnorm(1800, meanlog = meanlog, sdlog = sdlog, lower.tail = TRUE )
#49% 

#at what time would have the birds pulled the lever? 
qlnorm(0.5, meanlog = meanlog, sdlog = sdlog, lower.tail = TRUE )
#1874.5 

```

fitting parametric lognormal curve
```{r}
lnorm_values = rlnorm(1000, meanlog = meanlog, sdlog = sdlog)

modelfit.0 = tibble(time = pmin(8000,lnorm_values)) %>%                        
                      mutate(status = ifelse(time == 8000, 0,1), dataType = "model") 

observed.0 = lever2 %>% ungroup %>% dplyr::select(time, status) %>% mutate(dataType = "observed") 

dist.0 = bind_rows(modelfit.0,observed.0)

km.0 =  survfit(Surv(dist.0$time,dist.0$status) ~ strata(dist.0$dataType))

ggsurvplot(fit = km.0, data = dist.0, risk.table = F, conf.int = T, fun = "event", linetype = "strata", legend = "right", surv.median.line = 'hv') + labs(title = "Lognormal Fit of Chickadee Lever Pulling Probability")
```


##Weibull Regression 

Weibull regression modeling 100 birds each for 2 different levels of dominance
```{r}
survObject=Surv(lever3$left,lever3$right,type="interval2")

weibullMod = survreg(survObject~lever3$domscore, dist = "weibull")
summary(weibullMod)

b0 =  10.267
b1 = -3.085 

#make random dominance scores for birds: 
random_numbers <- function(n, min, max) {
  random_values <- runif(n, min = min, max = max)
  return(random_values)
}

lows = random_numbers(100,.01,.5)
highs = random_numbers(100,.51,.99)

sigma  = summary(weibullMod)$scale

#choose domscores of .25 and .75 to simulate 
low_dom_birds = rweibull(100, shape = 1/sigma, scale=exp(b0 + b1*lows))
#dom50_rural_adult = rweibull(100, shape = 1/sigma, scale=exp(b0 + b1*.50))
high_dom_birds = rweibull(100, shape = 1/sigma, scale=exp(b0 + b1*highs))

modelfit = tibble(domscore = c(lows,highs), 
                  time = pmin(8000,c(low_dom_birds,high_dom_birds))) %>%                        
                      mutate(status = ifelse(time == 8000, 0,1), dataType = "model") %>% 
                        mutate(dom_bin = case_when( 
                                  domscore <= .50 ~ "low", 
                                  domscore > .50 ~ "high"))

lever4 = lever3 %>% dplyr::select(domscore,dom_bin,time, status) 
lever4 = lever4 %>% ungroup %>% dplyr::select(-indiv, -habitat) %>% 
  mutate(dataType = "observed")

together = bind_rows(lever4, modelfit)

km7 = survfit(Surv(together$time, together$status) ~ strata(together$dom_bin) + strata(together$dataType))

ggsurvplot(fit = km7, data = together, fun = "event", conf.int = F, legend = "right")
```

Diagnostics 
```{r}

#diagnostics 
devresids=residuals(weibullMod,type="deviance")

#lever3 %>%
    #mutate(devresids=devresids) %>%
    #ggplot(aes(y=devresids,x=age,fill=age)) +
        #geom_boxplot() +
        #geom_hline(yintercept = 0,linetype="dotted") +
        #labs(title="Deviance Residuals for logNormal Model", x="age",y="Deviance Residuals") +
        #coord_flip() +
        #theme_minimal()

#plotting residuals in throwing error due to presence of NAs, I believe. 


#these models may not be most appropriate for this dataset

```





Cox proportional hazards model: 
Explanation of use of cox proportional hazards regression from study: 

"When analysing the predictors of problem-solving performance, we conducted an extended cox proportional hazards regression. This is a semi-parametric survival analysis approach that makes no assumptions about the distribution of the response variable [49]. We used this approach as an alternative to assigning capped latencies to individuals that did not solve a problem, which would suggest that the bird solved at that time and may not allow the data to meet assumptions of normality for commonly used regression analyses. Using censored observations allows us to avoid those assumptions and incorporate our limited knowledge of eachbirdâ€™s performance on a task (e.g. we only know that an unsuccessful bird was not able to solvea task in the time given)"

In other words, given the quantity of birds that did not complete the task and are therefore censored, using a semi-parametric regression model 


```{r}

cox_mod = coxph(Surv(time, status) ~ domscore + explscore + habitat + age, data = lever3)
summary(cox_mod)

ggsurvplot(survfit(cox_mod), fun = "event", data = lever3, surv.median.line = "hv")

#this plot makes sense in comparing the median value of 
median(lever3$time)

```





#####

##DATASET 2: Paper 

indiv: individual band number identification.
latency: latency to solve or become censored in the paper-ripping trials.
status: censoring status of latency to solve the paper-ripping task used for cox regression (0 = censored, 1 = uncensored).
tstart: start time (in seconds) of each time interval used for the extended cox regression.
tstop: stop time (in seconds) of each time interval used for the extended cox regression.
contacts: number of contacts made with the task in each time interval.
domscore: dominance score based on interactions between birds at RFID feeders.
urbanscore: urbanization score generated by PCA analysis used to infer degree of urbanization at each site.
explscore: exploration score generated by PCA analysis.
solve: indicator of whether the task was solved in each time interval (0 = unsolved, 1 = solved).
site: code of each field site.
habitat: rural (urban score < 0) or urban (urban score > 0) habitat type.

Getting acquainted with the Paper trial dataset
```{r}
paper
skim(paper)
```

```{r}
paper2 = paper %>% group_by(status, indiv, habitat) %>% summarize (time = max(tstop), contacts = sum(contacts), domscore = unique(domscore), urbanscore = unique(urbanscore), explscore = unique(explscore), solve = max(solve))

#general km curve all birds (no strata):

ggsurvplot(fit = paper2.km, data = paper2, risk.table = F, conf.int = T, fun = "event", surv.median.line = "hv") 

```

Dominance characteristic did not have a huge affect on ability to solve problem: 
```{r}

paper2 = paper2 %>%  mutate(dom_bin = case_when(domscore <= .34 ~ "low", 
                                  (domscore > .34 & domscore <=.67) ~ "medium", 
                                  domscore > .67 ~ "high"))

paper2.km2 = survfit(Surv(paper2$time,paper2$status) ~ paper2$dom_bin)

ggsurvplot(fit = paper2.km2, data = paper2, risk.table = F, conf.int = F, fun = "event") + labs(title = "Does more dominant mean better at paper test?")

#this is pretty close, I should run a log rank test to determine if there is a statistical difference in these curves 

survdiff(Surv(paper2$time,paper2$status) ~ paper2$dom_bin)
#dominance is not statistically  

#age has the biggest the 
```


```{r}
#binning expl_score 

 paper2 = paper2 %>% mutate(expl_bin = case_when(
                                explscore <= -1.5 ~ "low", 
                                explscore > -1.5 & explscore <= 1 ~ "medium", 
                                explscore > 1 ~ "high"))

#urban or rural: 
paper2.km3 = survfit(Surv(paper2$time,paper2$status) ~  strata(paper2$expl_bin))

ggsurvplot(fit = paper2.km3, data = paper2, risk.table = F, conf.int = F, fun = "event", legend = "right") + labs(title = "Rural vs. Urban Birds with Different Exploratory Scores")

#rural birds are better at solving at the beginning, but by the end they have the same likelihood of solving problem. 

```

```{r}
ggplot(paper2, aes(x = explscore, fill = habitat)) + geom_histogram()
#most urban birds are less exploratory, likely due to availability of food
```
```{r}
#comparing survival curves of urban vs. rural birds: 
paper2.km.habitat = paper2.km3 = survfit(Surv(paper2$time,paper2$status) ~ paper2$habitat)

ggsurvplot(fit = paper2.km3, data = paper2, risk.table = F, conf.int = F, fun = "event", legend = "right", surv.median.line = 'hv') + 
  labs(title = "Rural vs. Urban Birds")

#logrank test: 
survdiff(Surv(paper2$time,paper2$status) ~ paper2$habitat)
#p = 0.6 says that the different is not statistically significant, however small sample size may come into play here. 
```
Fitting parametric distribution
```{r}
paper3 = paper2 %>% mutate(left= ifelse(time == 0,time+.001,time), 
                  right= ifelse(status == 1,left, NA))

#weibull
weibullFit.paper3=fitdistcens(data.frame(paper3[,c("left","right")]), dist = "weibull")
summary(weibullFit.lever3)
plot(weibullFit.lever3)

#lognormal 


```

##DATASET 3: Persistence & Repeatability 

capturedate: date (yyyymmdd) that each bird was captured
site: code of each field site.
indiv: individual band number identification
age: age class â€“ adult or juvenile.
sex: female or male.
habitat: rural (urban score < 0) or urban (urban score > 0) habitat type.
urbanscore: urbanization score generated by PCA analysis used to infer degree of urbanization at each site.
explscore: exploration score generated by PCA analysis.
domscore: dominance score based on interactions between birds at RFID feeders.
lpsolve: whether the lever-pulling task was solved (Y) or not (N).
lplatency: latency to solve or become censored in the lever-pulling trials.
lpstatus: censoring status of latency to solve the lever-pulling task used for cox regression (0 = censored, 1 = uncensored).
lpcontacts: total number of contacts made with the lever-pulling task until the bird solved the task or the observation became censored.
prsolve: whether the paper-ripping task was solved (Y) or not (N).
prlatency: latency to solve or become censored in the paper-ripping trials.
prstatus: censoring status of latency to solve the paper-ripping task used for cox regression (0 = censored, 1 = uncensored).
prcontacts: total number of contacts made with the paper-ripping task until the bird solved the task or the observation became censored


```{r}


```



EDA FINDINGS: 

- There are only 65 birds in this trial 
- The covariates/characteristics here are domscore, urbanscore, explscore
- contacts. 
